---
// src/components/Sidebar.astro
import type { Props } from '@astrojs/starlight/props';
import Search from '@astrojs/starlight/components/Search.astro';

// 【重要】Starlight v0.32.0以降は Astro.locals.starlightRoute からデータを取得
const routeData = Astro.locals.starlightRoute;
const sidebar = routeData?.sidebar ?? [];
const currentPath = Astro.url.pathname;

// アイコン定義
const sectionIcons: Record<string, string> = {
  'getting-started': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>`,
  'core-concepts': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>`,
  'reference': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>`,
  'resources': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>`,
  'default': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>`
};

function getSectionIcon(href: string): string {
  if (!href) return sectionIcons['default'];
  const segment = href.split('/').filter(Boolean)[0];
  return sectionIcons[segment] || sectionIcons['default'];
}
---

<aside class="site-sidebar" aria-label="Sidebar navigation">
  <div class="sidebar-search-wrapper">
    <Search />
  </div>

  <nav class="sidebar-nav">
    {sidebar.map((group: any) => {
      const items = group.entries || group.items || [];

      return (
        <div class="sidebar-section">
          <div class="sidebar-title">{group.label}</div>
          <div class="sidebar-links">
            {items.map((entry: any) => {
              if (entry.type === 'group' && entry.entries) {
                return (
                  <div class="sidebar-nested-group">
                    <div class="sidebar-nested-title">{entry.label}</div>
                    {entry.entries.map((subEntry: any) => (
                      <a
                        href={subEntry.href}
                        class:list={['sidebar-link', 'nested', { active: currentPath === subEntry.href }]}
                      >
                        {subEntry.label}
                      </a>
                    ))}
                  </div>
                );
              }

              if (entry.type === 'link' || entry.href) {
                const isCurrentPage = currentPath === entry.href || currentPath === entry.href.slice(0, -1);
                const icon = getSectionIcon(entry.href);

                return (
                  <a
                    href={entry.href}
                    class:list={['sidebar-link', { active: isCurrentPage }]}
                    aria-current={isCurrentPage ? 'page' : undefined}
                  >
                    <span class="sidebar-icon" set:html={icon} />
                    <span class="sidebar-label">{entry.label}</span>
                  </a>
                );
              }
            })}
          </div>
        </div>
      );
    })}
  </nav>

  <div class="sidebar-footer">
    <a href="https://github.com/ato-sys" target="_blank" rel="noopener noreferrer" class="sidebar-footer-link">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
      </svg>
      <span>GitHub</span>
    </a>
    <a href="https://discord.gg/atosys" target="_blank" rel="noopener noreferrer" class="sidebar-footer-link">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
      <span>Discord</span>
    </a>
  </div>
</aside>

<style>
  .site-sidebar {
    position: fixed;
    top: 64px;
    left: 0;
    bottom: 0;
    width: 280px;
    background: var(--bg-card);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 30;
    overflow: hidden;
  }

  .sidebar-search-wrapper {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }

  .sidebar-search-wrapper :global(button[data-open-modal]),
  .sidebar-search-wrapper :global(.sl-search-button) {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 10px;
    padding: 10px 14px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--fg-tertiary);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .sidebar-search-wrapper :global(button[data-open-modal]:hover),
  .sidebar-search-wrapper :global(.sl-search-button:hover) {
    background: var(--bg-card);
    border-color: var(--fg-tertiary);
    color: var(--fg-secondary);
  }

  .sidebar-search-wrapper :global(button[data-open-modal] > svg),
  .sidebar-search-wrapper :global(.sl-search-button svg) {
    position: static;
    inset: auto;
    transform: none;
    flex-shrink: 0;
    width: 18px;
    height: 18px;
    opacity: 0.6;
  }

  .sidebar-search-wrapper :global(button[data-open-modal] > span),
  .sidebar-search-wrapper :global(.sl-search-button span) {
    margin: 0;
    line-height: 1.2;
  }

  .sidebar-search-wrapper :global(button[data-open-modal] > kbd),
  .sidebar-search-wrapper :global(.sl-search-button kbd) {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 4px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 2px 6px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
    border: 1px solid var(--border);
    color: var(--fg-tertiary);
  }

  .sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding: 16px 0;
  }

  .sidebar-section { padding: 8px 16px; }
  .sidebar-section:not(:last-child) { border-bottom: 1px solid var(--border-subtle); padding-bottom: 16px; margin-bottom: 8px; }
  .sidebar-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--fg-tertiary); padding: 8px 12px; margin-bottom: 4px; }
  .sidebar-links { display: flex; flex-direction: column; gap: 2px; }
  .sidebar-link { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 500; color: var(--fg-secondary); text-decoration: none; transition: all 0.15s ease; position: relative; }
  .sidebar-link:hover { background: var(--bg-elevated); color: var(--fg); }
  .sidebar-link.active { background: var(--accent-soft); color: var(--accent); }
  .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 16px; background: var(--accent); border-radius: 0 2px 2px 0; }
  .sidebar-icon { width: 16px; height: 16px; flex-shrink: 0; opacity: 0.5; color: currentColor; display: flex; align-items: center; justify-content: center; }
  .sidebar-icon :global(svg) { width: 100%; height: 100%; }
  .sidebar-link:hover .sidebar-icon, .sidebar-link.active .sidebar-icon { opacity: 1; }
  .sidebar-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: var(--bg); }
  .sidebar-footer-link { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 12px; font-size: 12px; font-weight: 500; color: var(--fg-tertiary); text-decoration: none; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; transition: all 0.15s ease; }
  .sidebar-footer-link:hover { color: var(--fg); border-color: var(--fg-tertiary); }

  @media (max-width: 1024px) { .site-sidebar { display: none; } }
  .site-sidebar.mobile-open { display: flex; position: fixed; z-index: 100; animation: slideIn 0.2s ease-out; }
  @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
</style>